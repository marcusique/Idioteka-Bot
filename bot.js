const Telegraf = require('telegraf'),
  Markup = require('telegraf/markup'),
  Extra = require('telegraf/extra'),
  axios = require('axios'),
  infoLogger = require('./middleware/infoLogger'),
  errorLogger = require('./middleware/errorLogger'),
  rateLimit = require('telegraf-ratelimit'),
  limitConfig = {
    window: 3000,
    limit: 1,
  },
  cheerio = require('cheerio'),
  session = require('telegraf/session'),
  keys = require('./config/keys'),
  lib = require('./middleware/lib'),
  bot = new Telegraf(keys.telegramBotToken);

bot.use(session());
bot.use(rateLimit(limitConfig));

bot.action('MORE', (ctx) => {
  const date = lib.generateDate();
  const requestUrl = `${keys.URL}${date}`;
  axios
    .get(requestUrl)
    .then((html) => {
      const $ = cheerio.load(html.data);
      const img = $('div.everiday-page-content-image > a > img').attr('src');
      const title = $('div.als-text-container > p.before_list').text();
      const caption = $('div.als-text-container > p').next().append('\n').text().trim();
      const extra = Extra.markup(Markup.inlineKeyboard([Markup.callbackButton('–ï—â–µ üöÄ', 'MORE')]));

      extra.caption = `<b>${title}</b>\n\n${caption}\n\n<a href="${requestUrl}">–ù–∞ —Å–∞–π—Ç</a> ‚ÜóÔ∏è`;
      extra.parse_mode = 'HTML';

      return done(ctx.chat.id, img, extra);
    })
    .catch((err) => {
      errorLogger.log({
        level: 'error',
        message: `CHAT: ${ctx.from.id}, USERNAME: ${ctx.from.username}, NAME: ${ctx.from.first_name} ${ctx.from.last_name}, ERROR_MSG: ${err.message} DATE: ${lib.returnDate(
          ctx.update.callback_query.message.date
        )}`,
      });
      return ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!');
    });
});

bot.start((ctx) => {
  const extra = Extra.markup(Markup.inlineKeyboard([Markup.callbackButton('–ù–∞—á–Ω–µ–º! üöÄ', 'MORE')]));
  extra.parse_mode = 'HTML';
  extra.webPreview(false);

  ctx.reply(
    `–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–∏—Å—ã–ª–∞—é —Å–ª—É—á–∞–π–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–∑ <a href="https://www.artlebedev.ru/kovodstvo/idioteka/">–ò–¥–∏–æ—Ç–µ–∫–∏</a>.
–î–ª—è —Å–ø—Ä–∞–≤–∫–∏ –Ω–∞–∂–º–∏ /help.
    `,
    extra
  );

  infoLogger.log({
    level: 'info',
    message: `CHAT: ${ctx.from.id}, USERNAME: ${ctx.from.username}, NAME: ${ctx.from.first_name} ${ctx.from.last_name}, MESSAGE: ${ctx.message.text}, DATE: ${lib.returnDate(
      ctx.message.date
    )}`,
  });
});

bot.help((ctx) => {
  const extra = Extra.markup(Markup.inlineKeyboard([Markup.callbackButton('–ù–∞—á–Ω–µ–º! üöÄ', 'MORE')]));
  extra.parse_mode = 'HTML';
  extra.webPreview(false);

  ctx.reply(
    `<b>–°–ø—Ä–∞–≤–∫–∞</b>

@idioteka_bot –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏–∑ <a href="https://www.artlebedev.ru/kovodstvo/idioteka/">–ò–¥–∏–æ—Ç–µ–∫–∏</a>.

–†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äì –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é —Å –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã. –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —Å–∞–π—Ç–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–æ—Ç–∞ –∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö –Ω–∞ —Å–∞–π—Ç –ò–¥–∏–æ—Ç–µ–∫–∏ –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è.

‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –æ–¥–Ω–∏–º –≤ –∫–∞–∂–¥—ã–µ —Ç—Ä–∏ —Å–µ–∫—É–Ω–¥—ã.
     `,
    extra
  );
  infoLogger.log({
    level: 'info',
    message: `CHAT: ${ctx.from.id}, USERNAME: ${ctx.from.username}, NAME: ${ctx.from.first_name} ${ctx.from.last_name}, MESSAGE: ${ctx.message.text}, DATE: ${lib.returnDate(
      ctx.message.date
    )}`,
  });
});

bot.catch((err) => {
  console.log(err.message);
  ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!');
});

function done(chatId, img, extra) {
  return bot.telegram.sendPhoto(chatId, img, extra);
}

bot.launch();
